$celementsweb.addExtJSfileOnce(':celJS/prototype.js')
$celementsweb.addExtJSfileOnce(':celJS/validation.js')
#macro(showForm $formMsg)
  <div id="cel_pwdrecovery_process_description">$formMsg</div>
  <form action="?" method="post" id="recovery" name="recovery" onsubmit="if(!valid.validate()) { return false; }" >
    <input type="hidden" name="xredirect" value="$!request.get('xredirect')" />
    <input type="hidden" name="xpage" value="overlay" />
    <input type="hidden" name="conf" value="PwdRetreival" />
    <label for="j_username">$msg.get("username"):</label>
    <input type="text" id="j_username" name="j_username" value="" class="required validate-email"/>
    <div class="buttons"><input type="submit" class="button" value="$msg.get('cel_password_recovery_button')" onclick="if(!valid.validate()) { return false; }"/></div>
  </form>
#end ##showForm
#set($celMailsPasswordRecovery = $xwiki.parseTemplate("celMails/PasswordRecoverMailHtmlContent_$!{default_language}.vm"))
#if(!$celementsweb.isEmptyRTEDocument('Tools.PasswordRecoverMailHtmlContent') || !$celementsweb.isEmptyRTEDocument('celements2web:Tools.PasswordRecoverMailHtmlContent') || !$celementsweb.isEmptyRTEDocument('Tools.PasswordRecoverMailTextContent') || !$celementsweb.isEmptyRTEDocument('celements2web:Tools.PasswordRecoverMailTextContent') || ("$!celMailsPasswordRecovery" != ''))
  #if("$!request.get('j_username')" != '')
    #if($!request.get('j_username').matches('[\w\.\-]+[@][\w\-]+([.]([\w\-]+))+$'))
      $xwiki.celementsweb.recoverPassword()
    #else
      #showForm($msg.get('cel_password_recovery_not_an_email', ["$!request.get('j_username')"]))
    #end
  #else
    #showForm($msg.get('cel_password_recovery_process_description'))
  #end
#end
<script type="text/javascript">
  var valid = new Validation('recovery',{immediate : true , useTitles : true, stopOnFirst : false});
</script>