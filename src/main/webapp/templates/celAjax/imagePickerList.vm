$response.setStatus(200)
#set($jsonBuilder = $services.celementsweb.getNewJSONBuilder())
#set($attachments = $xwiki.celementsweb.getAttachmentListSorted($doc, 'AttachmentDescendingChangeDateComparator'))
$jsonBuilder.openArray()
#foreach ($attach in $attachments)
#if ($attach.isImage())
 #set($dimensionObj = '')
 #set($dimensionObj = $xwiki.celementsphoto.getDimension("${doc.fullName};${attach.filename}"))
#if("$!dimensionObj" != '')
$jsonBuilder.openDictionary()
$jsonBuilder.addStringProperty('src', "$!doc.getAttachmentURL(${attach.filename}, 'download')")
$jsonBuilder.addStringProperty('filename', "$!{attach.filename}")
$jsonBuilder.addStringProperty('attversion', "$!{attach.version}")
$jsonBuilder.addStringProperty('lastChangedBy', "$!{xwiki.getLocalUserName($attach.author, false)}")
$jsonBuilder.openProperty('maxHeight')
$jsonBuilder.addInteger($mathtool.toInteger($!dimensionObj.getHeight()))
$jsonBuilder.openProperty('maxWidth')
$jsonBuilder.addInteger($mathtool.toInteger($!dimensionObj.getWidth()))
$jsonBuilder.addStringProperty('fileSize', "#dynamicsize(${attach.filesize})")
$jsonBuilder.addStringProperty('mimeType', "$!{attach.mimeType}")
$jsonBuilder.closeDictionary()
#end ## if got dimensions
#end ## if isImage
#end ## foreach
$jsonBuilder.closeArray()
$jsonBuilder.getJSON()