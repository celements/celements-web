#set($jsonBuilder = $services.json.newBuilder())
$jsonBuilder.openDictionary()
#set($map = $util.getHashMap())
#set($devnull = $map.putAll($request.getParameterMap()))
#set($validationResult = $services.editorsupport.validateRequest())
## Handle Validation Results
#set($validationPassed = ($validationResult.size() == 0))
#set($successful = $validationPassed)
#if($validationPassed)
  #set($updateResult = $services.docform.updateAndSaveDocFromMap($doc.documentReference, $map))
  $jsonBuilder.addProperty("numSavedDocVersions", $updateResult.get('successful').size())
  $jsonBuilder.openArray("successfullySaved")
  #foreach($savedDocRef in $updateResult.get('successful'))
    $jsonBuilder.addValue($services.model.serialize($savedDocRef, 'local'))
  #end
  $jsonBuilder.closeArray()
  $jsonBuilder.addProperty("numSaveDocFailed", $updateResult.get('failed').size())
  $jsonBuilder.openArray('errorMessages')
  #foreach($errDocRef in $updateResult.failed)
    $jsonBuilder.addValue("$adminMsg.get('cel_tm_saving_failed_document'): $services.model.serialize($errDocRef, 'local')")
  #end
  $jsonBuilder.closeArray()
  #set($successful = $updateResult.failed.isEmpty())
#else
  $jsonBuilder.openArray('errorMessages')
  #foreach($key in $validationResult.keySet())
    #foreach($messages in $validationResult.get($key).values())
      #foreach($msg in $messages)
        $jsonBuilder.addValue($adminMsg.get($msg))
      #end
      #if($services.stream.join($messages.stream(), '').isEmpty())
        $jsonBuilder.addValue($key)
      #end
    #end
  #end
  $jsonBuilder.closeArray()
#end
$jsonBuilder.addProperty('successful', $successful)
$jsonBuilder.closeDictionary()
$jsonBuilder.getJSON()
