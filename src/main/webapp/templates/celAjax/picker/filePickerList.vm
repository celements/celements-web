$response.setStatus(200)
#set($start = 0)
#if(("$!request.start" != '') && ($util.parseInt("$!request.start") > 0))
  #set($start = $util.parseInt("$!request.start"))
#end
#set($nb = 0)
#if(("$!request.nb" != '') && ($util.parseInt("$!request.nb") > 0))
  #set($nb = $util.parseInt("$!request.nb"))
#end
#set($comparator = 'AttachmentDescendingChangeDateComparator')
#if("$request.orderby" == 'AlphaAsc')
  #set($comparator = 'AttachmentAscendingNameComparator')
#elseif("$request.orderby" == 'AlphaDesc')
  #set($comparator = 'AttachmentDescendingNameComparator')
#elseif("$request.orderby" == 'ChangeDateAsc')
  #set($comparator = 'AttachmentAscendingChangeDateComparator')
#elseif("$request.orderby" == 'ChangeDateDesc')
  #set($comparator = 'AttachmentDescendingChangeDateComparator')
#end
#set($fileBaseDocRef = $services.reference.resolve("$!request.filebaseDocFN"))
#set($fileBaseDoc = $services.modelAccess.getDocument($fileBaseDocRef))
#set($onlyImages = ("$!request.onlyImages" == 'true'))
#if("$!request.spaceImgs" != '')
  #set($attachments = $xwiki.celementsweb.getAttachmentListForTagSortedSpace("$!request.spaceImgs", "$!request.tagList", $comparator, $onlyImages, $start, $nb))
#else
  #set($attachments = $xwiki.celementsweb.getAttachmentListForTagSorted($fileBaseDoc, "$!request.tagList", $comparator, $onlyImages, $start, $nb))
#end
#set($jsonBuilder = $services.json.newBuilder())
$jsonBuilder.openArray()
#foreach ($attach in $attachments)
  #set($attFileName = $attach.filename)
  #set($attachRef = $services.reference.create().with($attach.document.documentReference).att($attFileName).build())
  $jsonBuilder.openDictionary()
  $jsonBuilder.addProperty("src", $services.url.getURL($attachRef, 'download')) ## 'download' because of image resize
  $jsonBuilder.addProperty("filename", $attFileName)
  $jsonBuilder.addProperty("version", $attach.version)
  $jsonBuilder.addProperty("lastChangedBy", $attach.author)
  $jsonBuilder.addProperty("mimeType", $attach.mimeType)
  $jsonBuilder.addProperty("lastChanged", $datetool.formatDate("dd.MM.yyyy HH:mm", $attach.date))
  $jsonBuilder.addProperty("fileSize", $services.celementsweb.getHumanReadableSize($attach.filesize, true))
  $jsonBuilder.closeDictionary()
#end ## foreach
$jsonBuilder.closeArray()
$jsonBuilder.getJSON()
