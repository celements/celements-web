## request url has to conform to HttpServletResponse.sendRedirect(String), see javadoc
#set($url = "$!request.url")
#if("$!url" == "")
   #set($url = $doc.getExternalURL())
#end

#set($blacklisted = false)
#foreach($illegal in ["xxx","porn","t.co","4serial","ac.id","cleantalkorg2.ru","amazonaws.com","tiny.cc","bit.do","u.to","inx.lv","clck.ru","ulvis.net","chirayuexports.com","todaynewsleaks.com","inx.lv","clck.ru","ulvis.net","inventati.info","geita.info","secondchanceshepherds.org","makovik.info","adelantepodemos.info","domskazok.info","philsthoughts.info","acidright.info","afpel.info","bilbokobranka.info","blogslubny.info","domskazok.info","stimio.info","technoob.info","kamrulhasanshuvo.info","giurista.info","kollounawatani.info","latinasport.info","picshunter.info","sunujob.info","russisch-deutsche-hochzeit.net"])
  #set($blacklisted = $blacklisted || $url.contains($illegal))
#end

## Wird nicht auf jedes Dokument angewendet. Vor allem wegen des Tagesagenda Banners
## Probleme die bei einem content contains url check bestehen wuerden:
## 1. Banner im NL vom 20.3. soll auch am 30.3. noch funktionieren, auch wenn inzwischen der Link geaendert wurde
## 2. je nach Browser(?) kommen teils unterschiedlich escapte URLs zum Server. Dies koennte dazu fuehren, dass nicht korrekt
##    gematched werden kann und ein Redirect nicht funktioniert.
#set($docref = $doc.getDocumentReference())
#if($docref.getLastSpaceReference().getName().equals("ProgonEvent"))
  #set($blacklisted = $blacklisted || $doc.isNew()) ## document must exist catches e.g. 'ProgonEvent.ProgonEvent')
  #set($blacklisted = $blacklisted || ($docref.getName().equals("ProgonEvent108951") && !$url.contains('kaaoskaamos.com')))
  #set($blacklisted = $blacklisted || ($docref.getName().equals("ProgonEvent109175") && !$url.contains('ecas2017.ch')))
#end

## set context finished to prevent any content written to the Body
#if($blacklisted)
  $response.setStatus(403)
  <p><b>Sorry, the requested action is forbidden.</b></p>
#else
  $services.celementsweb.sendRedirect($url)
#end
